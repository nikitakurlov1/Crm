# Руководство по синхронизации реквизитов между CRM и биржей SellBit

## Обзор системы

Система синхронизации реквизитов позволяет автоматически обновлять реквизиты для оплаты на бирже при изменении их в CRM системе. Это обеспечивает актуальность данных и упрощает управление реквизитами.

## Архитектура системы

### Компоненты:
1. **CRM система** (`/requisites.html`) - управление реквизитами
2. **Биржа** (`/Dep.html`) - отображение реквизитов для пользователей
3. **API сервер** - связующее звено между CRM и биржей
4. **WebSocket** - реальное время обновления данных

### API Endpoints:

#### Для CRM:
- `GET /api/requisites` - получение всех реквизитов
- `POST /api/requisites` - создание нового реквизита
- `PUT /api/requisites/:id` - обновление реквизита
- `DELETE /api/requisites/:id` - удаление реквизита

#### Для биржи:
- `GET /api/exchange/requisites` - получение активных реквизитов для биржи
- `GET /api/exchange/requisites/ws` - WebSocket для реального времени

## Установка и настройка

### 1. Запуск сервера
```bash
node server.js
```

### 2. Добавление тестовых реквизитов
```bash
node add_test_requisites.js
```

### 3. Доступ к системам
- CRM: http://localhost:3000/requisites.html
- Биржа: http://localhost:3000/Dep.html

## Использование

### Управление реквизитами в CRM

1. **Добавление реквизитов:**
   - Откройте CRM по адресу `/requisites.html`
   - Нажмите "Добавить реквизиты"
   - Заполните форму:
     - Тип: карта/счет/криптовалюта
     - Название: описательное название
     - Номер: номер карты/счета/адрес кошелька
     - Банк: название банка или сети
     - Получатель: ФИО получателя
     - Статус: активные/неактивные/ожидающие
     - Описание: дополнительная информация

2. **Редактирование реквизитов:**
   - Нажмите кнопку редактирования (иконка карандаша)
   - Измените необходимые поля
   - Сохраните изменения

3. **Удаление реквизитов:**
   - Нажмите кнопку удаления (иконка корзины)
   - Подтвердите удаление

### Отображение на бирже

1. **Автоматическая синхронизация:**
   - Реквизиты автоматически загружаются из CRM
   - При изменении в CRM, биржа обновляется в реальном времени
   - Если CRM недоступна, используются резервные данные

2. **Типы реквизитов:**
   - **Банковские карты:** номер карты, получатель, банк
   - **Криптовалюты:** адреса кошельков (Bitcoin, Ethereum, USDT и др.)
   - **Банковские счета:** номер счета, получатель, банк

3. **Функции:**
   - Копирование реквизитов в буфер обмена
   - Уведомления об обновлениях
   - Автоматическое переподключение при потере связи

## Структура данных

### Реквизит в базе данных:
```json
{
  "id": "req_card_001",
  "type": "card",
  "name": "Основная карта Сбербанка",
  "number": "4276 1600 1234 5678",
  "bank": "ПАО Сбербанк",
  "holder": "ООО \"СейлБит\"",
  "status": "active",
  "description": "Основная карта для приема платежей в рублях",
  "createdAt": "2024-01-01T00:00:00.000Z",
  "updatedAt": "2024-01-01T00:00:00.000Z"
}
```

### Ответ API для биржи:
```json
{
  "success": true,
  "data": {
    "currency": "USD",
    "card": [
      {
        "id": "req_card_002",
        "type": "card",
        "name": "Долларовая карта Chase",
        "number": "4532 1234 5678 9012",
        "bank": "JPMorgan Chase Bank",
        "holder": "SaleBit LLC",
        "status": "active"
      }
    ],
    "crypto": [
      {
        "id": "req_crypto_001",
        "type": "crypto",
        "name": "Bitcoin кошелек",
        "number": "bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh",
        "bank": "Bitcoin",
        "holder": "SaleBit Exchange",
        "status": "active"
      }
    ],
    "transfer": [
      {
        "id": "req_account_002",
        "type": "account",
        "name": "Долларовый счет Chase",
        "number": "021000021",
        "bank": "JPMorgan Chase Bank",
        "holder": "SaleBit LLC",
        "status": "active"
      }
    ],
    "lastUpdated": "2024-01-01T00:00:00.000Z"
  }
}
```

## Безопасность

### Права доступа:
- **Админ:** полный доступ к управлению реквизитами
- **Менеджер:** чтение и редактирование реквизитов
- **Оператор:** только чтение реквизитов
- **Пользователь:** доступ только к публичному API

### Валидация данных:
- Проверка формата номеров карт
- Валидация криптовалютных адресов
- Проверка корректности банковских реквизитов

## Мониторинг и логирование

### Логирование действий:
- Создание реквизитов
- Изменение реквизитов
- Удаление реквизитов
- Доступ к API

### Мониторинг:
- Статус WebSocket соединений
- Время отклика API
- Количество запросов
- Ошибки синхронизации

## Устранение неполадок

### Проблемы с синхронизацией:
1. **Реквизиты не обновляются на бирже:**
   - Проверьте статус реквизитов в CRM (должны быть "активные")
   - Проверьте WebSocket соединение
   - Обновите страницу биржи

2. **Ошибка подключения к CRM:**
   - Проверьте, запущен ли сервер
   - Проверьте права доступа пользователя
   - Используйте резервные данные

3. **Неправильное отображение реквизитов:**
   - Проверьте формат данных в CRM
   - Убедитесь, что тип реквизита указан правильно
   - Проверьте консоль браузера на ошибки

### Часто используемые команды:
```bash
# Проверка статуса сервера
curl http://localhost:3000/api/health

# Получение реквизитов для биржи
curl http://localhost:3000/api/exchange/requisites

# Проверка WebSocket соединения
curl -N http://localhost:3000/api/exchange/requisites/ws
```

## Разработка и расширение

### Добавление новых типов реквизитов:
1. Обновите валидацию в `server.js`
2. Добавьте обработку в `Dep.js`
3. Обновите стили в CSS
4. Добавьте тестовые данные

### Интеграция с внешними системами:
1. Создайте новые API endpoints
2. Добавьте аутентификацию
3. Реализуйте webhook'и для уведомлений
4. Добавьте логирование интеграций

## Контакты и поддержка

При возникновении вопросов или проблем:
- Создайте issue в репозитории
- Обратитесь к документации API
- Проверьте логи сервера
- Используйте систему мониторинга
